// packages/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== AUTH & ORGANIZATIONS =====

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String?
  avatar        String?
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  memberships               Membership[]
  refreshTokens             RefreshToken[]
  sentInvitations           Invitation[]
  assignedLeads             Lead[]                     @relation("LeadAssignee")
  createdLeads              Lead[]                     @relation("LeadCreator")
  createdSales              Sale[]                     @relation("SaleCreator")
  assignedSales             Sale[]                     @relation("SaleAssignedTo")
  notes                     Note[]
  assignedTasks             Task[]                     @relation("TaskAssignedTo")
  createdTasks              Task[]                     @relation("TaskCreator")
  StockMovement             StockMovement[]
  StockReservation          StockReservation[]
  idempotencyKeys           IdempotencyKey[]
  createdCustomers          Customer[]                 @relation("CustomerCreator")
  assignedCustomers         Customer[]                 @relation("CustomerAssignedTo")
  createdVendors            Vendor[]                   @relation("VendorCreator")
  createdPurchases          Purchase[]                 @relation("PurchaseCreator")
  purchaseStockApplications PurchaseStockApplication[] @relation("PurchaseStockApplier")
  createdJournalEntries     JournalEntry[]             @relation("JournalEntryCreator")
  commissionConfigs         CommissionConfig[]         @relation("CommissionSeller")
  commissionPerModels        CommissionPerModel[]      @relation("CommissionPerModelSeller")

  @@index([email])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  settings  Json? // Configuraciones generales
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  members                  Membership[]
  invitations              Invitation[]
  refreshTokens            RefreshToken[]
  leads                    Lead[]
  stockItems               StockItem[]
  stockReservations        StockReservation[]
  stockMovements           StockMovement[]
  pricingRules             PricingRule[]
  sales                    Sale[]
  tasks                    Task[]
  notes                    Note[]
  auditLogs                AuditLog[]
  idempotencyKeys          IdempotencyKey[]
  connectedAccounts        ConnectedAccount[]
  integrationJobs          IntegrationJob[]
  items                    Item[]
  folderPrefixes           FolderPrefix[]
  folders                  Folder[]
  priceLists               PriceList[]
  customers                Customer[]
  ledgerAccounts           LedgerAccount[]
  journalEntries           JournalEntry[]
  vendors                  Vendor[]
  purchases                Purchase[]
  ledgerCategories         LedgerCategory[]
  customerBalanceSnapshots CustomerBalanceSnapshot[]
  PurchaseStockApplication PurchaseStockApplication[]
  PriceListItem            PriceListItem[]
  PriceListItemOverride    PriceListItemOverride[]
  commissionConfigs        CommissionConfig[]
  commissionPerModels      CommissionPerModel[]

  @@index([slug])
}

model Membership {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  role           Role     @default(SELLER)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId, role])
  @@index([userId])
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  SELLER
}

model RefreshToken {
  id             String   @id @default(cuid())
  token          String   @unique
  userId         String
  organizationId String
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([userId, organizationId])
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  email          String
  role           Role         @default(SELLER)
  token          String       @unique
  status         InviteStatus @default(PENDING)
  invitedById    String
  acceptedAt     DateTime?
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])

  @@unique([organizationId, email, status])
  @@index([token])
  @@index([email, status])
  @@index([organizationId])
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ===== CRM LEADS =====

model Lead {
  id             String  @id @default(cuid())
  organizationId String
  assignedToId   String?
  createdById    String

  // Campos estándar
  name   String
  email  String?
  phone  String?
  source String? // "instagram", "tiktok", "manual", etc.
  city   String?
  budget Decimal? @db.Decimal(10, 2)
  model  String? // "iPhone 15 Pro", etc.

  // Campos custom (JSON para flexibilidad)
  customFields Json? // { "preferredColor": "blue", "tradeIn": true, ... }
  tags         String[] @default([])

  status      LeadStatus @default(ACTIVE)
  convertedAt DateTime?
  deletedAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedTo   User?        @relation("LeadAssignee", fields: [assignedToId], references: [id])
  creator      User         @relation("LeadCreator", fields: [createdById], references: [id])

  notes                    Note[]
  tasks                    Task[]
  sales                    Sale[]

  @@index([organizationId, assignedToId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
}

enum LeadStatus {
  ACTIVE
  CONVERTED
  LOST
  ARCHIVED
}

model Note {
  id             String   @id @default(cuid())
  organizationId String
  leadId         String?
  userId         String
  content        String   @db.Text
  isPrivate      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lead         Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId, leadId])
  @@index([createdAt])
}

model Task {
  id             String    @id @default(cuid())
  organizationId String
  leadId         String?
  assignedToId   String
  createdById    String
  title          String
  description    String?   @db.Text
  dueDate        DateTime?
  completed      Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lead         Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  assignedTo   User         @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  creator      User         @relation("TaskCreator", fields: [createdById], references: [id])

  @@index([organizationId, assignedToId, completed])
  @@index([organizationId, dueDate])
}

// ===== STOCK & PRICING =====

model StockItem {
  id             String        @id @default(cuid())
  organizationId String
  itemId         String // FK to Item (product catalog)
  sku            String? // SKU interno
  model          String // "iPhone 15 Pro 256GB"
  storage        String? // "256GB"
  color          String? // "Natural Titanium"
  condition      ItemCondition @default(NEW)
  imei           String?
  serialNumber   String?
  quantity       Int           @default(1) // Para lotes sin IMEI
  costPrice      Decimal       @db.Decimal(10, 2)
  basePrice      Decimal       @db.Decimal(10, 2) // Precio base antes de reglas
  status         StockStatus   @default(AVAILABLE)
  location       String? // "Almacén A", "En tránsito", etc.
  notes          String?       @db.Text
  metadata       Json? // Info adicional (proveedor, fecha compra, etc.)
  deletedAt      DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item              Item               @relation(fields: [itemId], references: [id], onDelete: Restrict)
  reservations      SaleItem[]
  movements         StockMovement[]
  stockReservations StockReservation[]
  PurchaseLine      PurchaseLine[]

  @@unique([organizationId, imei]) // IMEI único por organización
  @@index([organizationId, status])
  @@index([organizationId, model])
  @@index([organizationId, itemId])
  @@index([sku])
}

// ===== ITEMS (Product Catalog) =====

model Item {
  id             String         @id @default(cuid())
  organizationId String
  folderId       String? // FK to Folder - items must belong to a folder
  name           String
  sku            String?
  category       String?
  brand          String?
  model          String? // e.g., "iPhone 15 Pro"
  storageGb      Int? // e.g., 64, 128, 256, 512, 1024
  condition      ItemCondition?
  color          String? // e.g., "Natural Titanium", "Blue"
  description    String?        @db.Text
  attributes     Json? // Flexible attributes (color, size, etc.)
  isActive       Boolean        @default(true)
  seedSource     String? // e.g., "APPLE_IPHONE"
  seedVersion    Int? // e.g., 2
  sortKey        String?        @db.VarChar(64) // For canonical ordering
  deletedAt      DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  folder       Folder?            @relation(fields: [folderId], references: [id], onDelete: SetNull)
  stockItems   StockItem[]
  reservations StockReservation[]

  @@index([organizationId, isActive])
  @@index([organizationId, deletedAt])
  @@index([sku])
  @@index([name])
  @@index([organizationId, model])
  @@index([organizationId, brand])
  @@index([organizationId, sortKey])
  @@index([folderId])
  @@index([organizationId, folderId])
}

enum ItemCondition {
  NEW
  USED
  REFURBISHED
  OEM
}

// ===== ITEMS FOLDERS (SKU Prefix Organization) =====

model FolderPrefix {
  id             String   @id @default(cuid())
  organizationId String
  prefix         String // e.g., "IPH", "IPAD", "SAM"
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, prefix])
  @@index([organizationId])
}

// ===== ITEMS FOLDERS (Real Folders) =====

model Folder {
  id             String   @id @default(cuid())
  organizationId String
  name           String // e.g., "iPhone", "iPad", "Samsung"
  description    String?  @db.Text
  isDefault      Boolean  @default(false) // System default folder (e.g., "IPHONE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        Item[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, isDefault])
}

// ===== PRICE LISTS =====

model PriceList {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items        PriceListItem[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model PriceListItem {
  id             String   @id @default(cuid())
  organizationId String
  priceListId    String
  itemGroupKey   String // Key for grouping items without color (e.g., "IPHONE_11_128GB_NEW")
  displayName    String // Human-friendly name (e.g., "iPhone 11 128GB NEW")
  baseSku        String? // Optional base SKU pattern
  basePrice      Decimal? @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  priceList    PriceList               @relation(fields: [priceListId], references: [id], onDelete: Cascade)
  overrides    PriceListItemOverride[]

  @@unique([priceListId, itemGroupKey])
  @@index([organizationId])
  @@index([priceListId])
  @@index([itemGroupKey])
}

model PriceListItemOverride {
  id              String   @id @default(cuid())
  organizationId  String
  priceListItemId String
  variantKey      String // e.g., "COLOR=GOLD" or specific SKU
  price           Decimal  @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization  Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  priceListItem PriceListItem @relation(fields: [priceListItemId], references: [id], onDelete: Cascade)

  @@unique([priceListItemId, variantKey])
  @@index([organizationId])
  @@index([priceListItemId])
}

enum StockStatus {
  AVAILABLE
  RESERVED
  SOLD
  DAMAGED
  RETURNED
  CANCELLED
}

enum StockMovementType {
  IN
  OUT
  RESERVE
  RELEASE
  ADJUST
  SOLD
}

enum ReservationStatus {
  ACTIVE
  CONFIRMED
  EXPIRED
  CANCELLED
  RELEASED
}

model PricingRule {
  id             String    @id @default(cuid())
  organizationId String
  name           String
  priority       Int       @default(0) // Mayor = más prioridad
  isActive       Boolean   @default(true)
  ruleType       RuleType // MARKUP_PERCENT, MARKUP_FIXED, OVERRIDE_PRICE
  scopeType      ScopeType @default(GLOBAL) // GLOBAL, BY_PRODUCT, BY_CONDITION, BY_CATEGORY

  // Matchers (JSON para flexibilidad)
  // { "model": "iPhone 15 Pro", "condition": "USED", "category": "premium" }
  matchers Json? // Campos para matchear: model, condition, storage, color, etc.

  // Valor según ruleType:
  // MARKUP_PERCENT: porcentaje (ej: 20.00 = 20%)
  // MARKUP_FIXED: monto fijo (ej: 100.00)
  // OVERRIDE_PRICE: precio final (ej: 1500.00)
  value Decimal @db.Decimal(10, 2)

  currency  String    @default("USD")
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isActive, priority])
  @@index([organizationId, scopeType])
}

enum RuleType {
  MARKUP_PERCENT
  MARKUP_FIXED
  OVERRIDE_PRICE
}

enum ScopeType {
  GLOBAL
  BY_PRODUCT
  BY_CONDITION
  BY_CATEGORY
}

// ===== SALES =====

model Sale {
  id             String     @id @default(cuid())
  organizationId String
  leadId         String? // Si viene de un lead
  createdById    String // Usuario que crea la venta
  assignedToId   String // Vendedor asignado
  saleNumber     String     @unique // "SALE-2024-001"
  status         SaleStatus @default(DRAFT)

  // Cliente
  customerName  String
  customerEmail String?
  customerPhone String?
  customerCity  String?

  // Monto
  subtotal Decimal @db.Decimal(10, 2)
  discount Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Fechas
  reservedAt  DateTime?
  paidAt      DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?

  notes     String?   @db.Text
  metadata  Json? // Tracking info, etc.
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  organization            Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lead                    Lead?                    @relation(fields: [leadId], references: [id])
  createdBy               User                     @relation("SaleCreator", fields: [createdById], references: [id])
  assignedTo              User                     @relation("SaleAssignedTo", fields: [assignedToId], references: [id])
  items                   SaleItem[]
  stockReservations       StockReservation[]
  stockMovements          StockMovement[]

  @@index([organizationId, status])
  @@index([organizationId, assignedToId])
  @@index([organizationId, createdById])
  @@index([organizationId, createdAt])
  @@index([saleNumber])
}

enum SaleStatus {
  DRAFT
  RESERVED
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}

model SaleItem {
  id          String   @id @default(cuid())
  saleId      String
  stockItemId String? // Nullable si el item fue eliminado
  model       String // Snapshot del modelo al momento de la venta
  quantity    Int      @default(1)
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  sale      Sale       @relation(fields: [saleId], references: [id], onDelete: Cascade)
  stockItem StockItem? @relation(fields: [stockItemId], references: [id], onDelete: SetNull)

  @@index([saleId])
  @@index([stockItemId])
}

// ===== CUSTOMERS & VENDORS =====

model Customer {
  id             String  @id @default(cuid())
  organizationId String
  createdById    String?
  assignedToId   String? // Vendedor asignado

  name       String
  email      String?
  phone      String?
  taxId      String? // CUIT, DNI, etc.
  city       String?
  address    String?
  instagram  String?
  web        String?
  notes      String?
  status     String  @default("ACTIVE") // ACTIVE, INACTIVE

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization     Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy        User?                     @relation("CustomerCreator", fields: [createdById], references: [id], onDelete: SetNull)
  assignedTo       User?                     @relation("CustomerAssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  balanceSnapshots CustomerBalanceSnapshot[]

  @@index([organizationId, createdAt])
  @@index([organizationId, name])
  @@index([organizationId, status])
  @@index([organizationId, assignedToId])
  @@unique([organizationId, email])
}

// ===== COMMISSIONS =====

model CommissionConfig {
  id             String   @id @default(cuid())
  organizationId String
  sellerId       String   // User ID del vendedor
  mode           String   // PER_UNIT, PERCENT_GROSS_PROFIT, PER_MODEL, PERCENT_SALE
  value          Decimal  @db.Decimal(10, 2) // Valor según el modo
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  seller       User         @relation("CommissionSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([organizationId, sellerId])
  @@index([organizationId])
  @@index([sellerId])
}

model CommissionPerModel {
  id             String   @id @default(cuid())
  organizationId String
  sellerId       String
  itemGroupKey   String   // Key del grupo de items (sin color)
  value          Decimal  @db.Decimal(10, 2)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  seller       User         @relation("CommissionPerModelSeller", fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([organizationId, sellerId, itemGroupKey])
  @@index([organizationId])
  @@index([sellerId])
  @@index([itemGroupKey])
}

model Vendor {
  id             String  @id @default(cuid())
  organizationId String
  createdById    String?

  name   String
  email  String?
  phone  String?
  notes  String?
  status String  @default("ACTIVE") // ACTIVE, INACTIVE

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("VendorCreator", fields: [createdById], references: [id], onDelete: SetNull)
  purchases    Purchase[]

  @@index([organizationId, createdAt])
  @@index([organizationId, name])
  @@index([organizationId, status])
}

model Purchase {
  id             String  @id @default(cuid())
  organizationId String
  vendorId       String
  createdById    String?

  status          PurchaseStatus @default(DRAFT)
  notes           String?
  currency        String         @default("USD")
  referenceNumber String? // Optional reference number

  subtotalCents Int
  taxCents      Int @default(0)
  totalCents    Int

  approvedAt  DateTime?
  receivedAt  DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization     Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor           Vendor                    @relation(fields: [vendorId], references: [id], onDelete: Restrict)
  createdBy        User?                     @relation("PurchaseCreator", fields: [createdById], references: [id], onDelete: SetNull)
  lines            PurchaseLine[]
  stockApplication PurchaseStockApplication?

  @@index([organizationId, createdAt])
  @@index([organizationId, status])
  @@index([organizationId, vendorId])
}

model PurchaseLine {
  id             String  @id @default(cuid())
  purchaseId     String
  description    String
  quantity       Int
  unitPriceCents Int
  lineTotalCents Int
  sku            String? // Para futuro mapeo a StockItem
  stockItemId    String? // Mapeo directo a StockItem si existe

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchase  Purchase   @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  stockItem StockItem? @relation(fields: [stockItemId], references: [id], onDelete: SetNull)

  @@index([purchaseId])
  @@index([stockItemId])
}

enum PurchaseStatus {
  DRAFT
  APPROVED
  RECEIVED
  CANCELLED
}

// ===== ACCOUNTING-LITE (Prep for Zoho Books) =====

model LedgerAccount {
  id             String   @id @default(cuid())
  organizationId String
  code           String // Account code (e.g., "1000", "2000")
  name           String
  type           String // ASSET, LIABILITY, EQUITY, REVENUE, EXPENSE
  currency       String   @default("ARS") // ISO currency code
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  journalLines JournalLine[]

  @@unique([organizationId, code])
  @@index([organizationId, type])
  @@index([organizationId, isActive])
}

model LedgerCategory {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, name])
}

model CustomerBalanceSnapshot {
  id             String   @id @default(cuid())
  organizationId String
  customerId     String
  balanceCents   Int // Balance in cents (can be negative for credit)
  asOfDate       DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([organizationId, customerId, asOfDate])
  @@index([organizationId, customerId])
  @@index([organizationId, asOfDate])
}

// ===== JOURNAL ENTRIES (Accounting-Lite) =====

model JournalEntry {
  id             String   @id @default(cuid())
  organizationId String
  date           DateTime @db.Date
  memo           String?  @db.Text
  sourceType     String? // "SALE", "PURCHASE", "MANUAL", etc.
  sourceId       String? // ID of source record (saleId, purchaseId, etc.)
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User          @relation("JournalEntryCreator", fields: [createdById], references: [id])
  lines        JournalLine[]

  @@index([organizationId, date])
  @@index([organizationId, sourceType, sourceId])
  @@index([organizationId, createdById])
}

model JournalLine {
  id        String   @id @default(cuid())
  entryId   String
  accountId String
  debit     Decimal  @default(0) @db.Decimal(18, 2)
  credit    Decimal  @default(0) @db.Decimal(18, 2)
  memo      String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  entry   JournalEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  account LedgerAccount @relation(fields: [accountId], references: [id])

  @@index([entryId])
  @@index([accountId])
}

// ===== PURCHASE STOCK APPLICATION (Idempotency) =====

model PurchaseStockApplication {
  id              String   @id @default(cuid())
  organizationId  String
  purchaseId      String   @unique
  appliedAt       DateTime @default(now())
  appliedByUserId String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  purchase     Purchase     @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  appliedBy    User         @relation("PurchaseStockApplier", fields: [appliedByUserId], references: [id], onDelete: Restrict)

  @@index([organizationId, appliedAt])
  @@index([purchaseId])
}

model StockMovement {
  id             String            @id @default(cuid())
  organizationId String
  stockItemId    String
  type           StockMovementType
  quantity       Int // Cantidad afectada
  quantityBefore Int // Cantidad antes del movimiento
  quantityAfter  Int // Cantidad después del movimiento
  reason         String? // Motivo del movimiento
  reservationId  String?
  saleId         String?
  createdById    String
  metadata       Json? // Info adicional
  createdAt      DateTime          @default(now())

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stockItem    StockItem         @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  reservation  StockReservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)
  sale         Sale?             @relation(fields: [saleId], references: [id], onDelete: SetNull)
  createdBy    User              @relation(fields: [createdById], references: [id], onDelete: Restrict)

  @@index([organizationId])
  @@index([stockItemId])
  @@index([type])
  @@index([createdAt])
  @@index([reservationId])
  @@index([saleId])
}

model StockReservation {
  id             String            @id @default(cuid())
  organizationId String
  itemId         String? // FK to Item (product catalog) - for quantity-based reservations
  stockItemId    String? // FK to StockItem - for legacy/specific item reservations
  quantity       Int               @default(1)
  status         ReservationStatus @default(ACTIVE)
  expiresAt      DateTime?
  releasedAt     DateTime? // When reservation was released
  saleId         String?
  createdById    String
  customerName   String? // Customer name for the reservation
  notes          String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  item         Item?           @relation(fields: [itemId], references: [id], onDelete: Restrict)
  stockItem    StockItem?      @relation(fields: [stockItemId], references: [id], onDelete: Cascade)
  sale         Sale?           @relation(fields: [saleId], references: [id], onDelete: SetNull)
  createdBy    User            @relation(fields: [createdById], references: [id], onDelete: Restrict)
  movements    StockMovement[]

  @@index([organizationId])
  @@index([itemId])
  @@index([stockItemId])
  @@index([status])
  @@index([saleId])
  @@index([expiresAt])
}

// ===== AUDIT LOG =====

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
  PAY
  CANCEL
  RESERVE
  CONFIRM
  RELEASE
  SHIP
  DELIVER
  ASSIGN
  ADJUST
}

enum AuditEntityType {
  Lead
  StockItem
  Sale
  PricingRule
  StockReservation
  SaleItem
  Note
  Task
  Customer
  Vendor
  Purchase
  LedgerAccount
  LedgerCategory
  Item
}

model AuditLog {
  id             String          @id @default(cuid())
  organizationId String
  actorUserId    String?
  action         AuditAction
  entityType     AuditEntityType
  entityId       String
  beforeJson     Json?
  afterJson      Json?
  metadataJson   Json?
  requestId      String?
  createdAt      DateTime        @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([actorUserId, createdAt])
  @@index([requestId])
}

// ===== IDEMPOTENCY =====

model IdempotencyKey {
  id             String   @id @default(uuid())
  organizationId String
  userId         String
  method         String
  path           String
  key            String
  requestHash    String
  statusCode     Int?
  responseBody   Json?
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, method, path, key])
  @@index([expiresAt])
  @@index([organizationId, createdAt])
  @@map("idempotency_keys")
}

// ============================================
// INTEGRATIONS MODELS
// ============================================

enum IntegrationProvider {
  FACEBOOK
}

enum ConnectedAccountStatus {
  CONNECTED
  DISCONNECTED
  ERROR
}

enum WebhookEventStatus {
  PENDING
  PROCESSED
  FAILED
}

enum IntegrationJobType {
  SEND_MESSAGE
  SEND_MESSAGE_TEMPLATE
  PROCESS_WEBHOOK
  SYNC_ACCOUNT
  RETRY
  AUTOMATION_ACTION
}

enum IntegrationJobStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

model ConnectedAccount {
  id                String                 @id @default(uuid())
  organizationId    String
  provider          IntegrationProvider
  externalAccountId String
  displayName       String?
  status            ConnectedAccountStatus @default(CONNECTED)
  metadataJson      Json? // { metaUserId, pageId, igUserId, adAccounts: [...] }
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  oauthTokens     OAuthToken[]
  integrationJobs IntegrationJob[]

  @@unique([organizationId, provider, externalAccountId])
  @@index([organizationId, provider])
  @@index([organizationId, status])
}

model OAuthToken {
  id                    String    @id @default(uuid())
  connectedAccountId    String
  accessTokenEncrypted  String // Base64 encoded encrypted token
  refreshTokenEncrypted String? // Base64 encoded encrypted token (optional)
  expiresAt             DateTime?
  scopes                String[]
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  connectedAccount ConnectedAccount @relation(fields: [connectedAccountId], references: [id], onDelete: Cascade)

  @@index([connectedAccountId])
}

model WebhookEvent {
  id          String              @id @default(uuid())
  provider    IntegrationProvider
  eventType   String
  payloadJson Json
  receivedAt  DateTime            @default(now())
  processedAt DateTime?
  status      WebhookEventStatus  @default(PENDING)
  retries     Int                 @default(0)

  @@index([provider, status])
  @@index([status, receivedAt])
}


model IntegrationJob {
  id                 String               @id @default(uuid())
  organizationId     String
  provider           IntegrationProvider
  jobType            IntegrationJobType
  payloadJson        Json
  status             IntegrationJobStatus @default(PENDING)
  attempts           Int                  @default(0)
  lastError          String?
  runAt              DateTime             @default(now())
  connectedAccountId String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt

  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connectedAccount ConnectedAccount? @relation(fields: [connectedAccountId], references: [id], onDelete: SetNull)

  @@index([status, runAt])
  @@index([organizationId, status])
  @@index([provider, status])
}

// ===== JOB RUNNER LOCK & STATE =====

model JobRunnerLock {
  id        String   @id @default("singleton") // Singleton pattern
  lockedBy  String // Worker instance ID (hostname + pid)
  lockedAt  DateTime @default(now())
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("job_runner_lock")
}

model JobRunnerState {
  id                String    @id @default("singleton") // Singleton pattern
  lastRunAt         DateTime?
  lastRunDurationMs Int?
  lastRunJobCount   Int?
  lastRunError      String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("job_runner_state")
}

